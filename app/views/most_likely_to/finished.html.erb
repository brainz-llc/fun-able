<% content_for :title, "Partida Terminada - Quien es Mas Probable" %>
<% content_for :hide_footer, true %>

<%
  winner = @game.leaderboard.first
  leaderboard = @game.leaderboard
  current_player = @game.player_for(current_user)
  my_rank = leaderboard.to_a.index(current_player).to_i + 1
%>

<div class="min-h-screen relative overflow-hidden py-8 px-4">
  <!-- Animated Background -->
  <div class="absolute inset-0 pointer-events-none">
    <div class="absolute top-0 left-0 -translate-x-1/2 w-64 h-64 md:w-[500px] md:h-[500px] bg-yellow-500/15 rounded-full blur-3xl animate-pulse"></div>
    <div class="absolute top-1/3 right-0 translate-x-1/2 w-80 h-80 md:w-[500px] md:h-[500px] bg-purple-500/10 rounded-full blur-3xl animate-pulse" style="animation-delay: 1s;"></div>
    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2 w-96 h-96 md:w-[600px] md:h-[600px] bg-pink-500/10 rounded-full blur-3xl animate-pulse" style="animation-delay: 2s;"></div>
  </div>

  <div class="relative z-10 max-w-lg mx-auto text-center">
    <!-- Trophy -->
    <div class="mb-8">
      <div class="inline-flex items-center justify-center w-24 h-24 rounded-full mb-4"
           style="background: linear-gradient(145deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%);
                  border: 2px solid rgba(251, 191, 36, 0.4);
                  box-shadow: 0 0 50px rgba(251, 191, 36, 0.3);
                  animation: winnerGlow 2s ease-in-out infinite;">
        <span class="text-5xl">üèÜ</span>
      </div>

      <h1 class="text-3xl md:text-4xl font-black text-white mb-2">
        Partida Terminada!
      </h1>
      <p class="text-white/60">
        <span class="text-yellow-400 font-bold"><%= @game.current_round %></span> rondas jugadas
      </p>
    </div>

    <!-- Winner Card -->
    <% if winner %>
      <div class="p-6 rounded-2xl mb-8"
           style="background: linear-gradient(145deg, rgba(251, 191, 36, 0.1) 0%, rgba(0,0,0,0.5) 100%);
                  border: 2px solid rgba(251, 191, 36, 0.4);
                  box-shadow: 0 0 40px rgba(251, 191, 36, 0.2);">
        <p class="text-sm text-yellow-400/70 uppercase tracking-wider mb-3">Campeon de los Tragos</p>

        <div class="w-20 h-20 mx-auto rounded-full flex items-center justify-center text-2xl font-bold text-white mb-3"
             style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
                    box-shadow: 0 0 30px rgba(251, 191, 36, 0.4);">
          <%= winner.avatar_initials %>
        </div>

        <h2 class="text-2xl font-bold text-white mb-2"><%= winner.display_name %></h2>

        <div class="flex items-center justify-center gap-2 text-3xl font-black text-yellow-400">
          <span>üç∫</span>
          <span><%= winner.drinks %></span>
          <span class="text-lg text-white/50">tragos</span>
        </div>
      </div>
    <% end %>

    <!-- Full Leaderboard -->
    <div class="rounded-2xl p-6 mb-8"
         style="background: rgba(15, 15, 15, 0.8); border: 1px solid rgba(168, 85, 247, 0.2);">
      <h3 class="font-bold text-white mb-4 flex items-center justify-center gap-2">
        <span>üìä</span> Tabla de Posiciones
      </h3>

      <div class="space-y-2">
        <% leaderboard.each_with_index do |player, index| %>
          <%
            is_me = player.id == current_player&.id
            rank_class = case index
                         when 0 then 'text-yellow-400'
                         when 1 then 'text-gray-400'
                         when 2 then 'text-orange-600'
                         else 'text-white/50'
                         end
            rank_emoji = case index
                         when 0 then 'ü•á'
                         when 1 then 'ü•à'
                         when 2 then 'ü•â'
                         else ''
                         end
          %>
          <div class="flex items-center justify-between p-3 rounded-xl
                      <%= is_me ? 'bg-purple-500/20 border border-purple-500/40' : 'bg-white/5' %>">
            <div class="flex items-center gap-3">
              <span class="text-lg font-bold <%= rank_class %> w-8">
                <%= rank_emoji.present? ? rank_emoji : "##{index + 1}" %>
              </span>
              <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white"
                   style="background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);">
                <%= player.avatar_initials %>
              </div>
              <span class="font-medium text-white">
                <%= player.display_name %>
                <%= '(Tu)' if is_me %>
              </span>
            </div>
            <div class="flex items-center gap-1 text-cyan-400 font-bold">
              <span>üç∫</span>
              <span><%= player.drinks %></span>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Your Stats -->
    <% if current_player %>
      <div class="p-4 rounded-xl mb-8"
           style="background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.2);">
        <p class="text-purple-400 font-medium mb-2">Tu resultado</p>
        <p class="text-white">
          Quedaste en el <span class="text-purple-400 font-bold">#<%= my_rank %></span> lugar
          con <span class="text-cyan-400 font-bold"><%= current_player.drinks %></span> tragos
        </p>
      </div>
    <% end %>

    <!-- Actions -->
    <div class="space-y-4">
      <%= link_to "Nueva Partida",
          new_most_likely_to_path,
          class: "block w-full py-4 rounded-xl font-bold text-white text-lg text-center transition-all hover:scale-[1.02]",
          style: "background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%); box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);" %>

      <%= link_to "Volver al Inicio",
          root_path,
          class: "block w-full py-3 rounded-xl font-medium text-white/60 hover:text-white bg-white/5 hover:bg-white/10 text-center transition-all" %>
    </div>
  </div>
</div>

<style>
@keyframes winnerGlow {
  0%, 100% {
    box-shadow: 0 0 30px rgba(251, 191, 36, 0.3), 0 0 60px rgba(251, 191, 36, 0.1);
  }
  50% {
    box-shadow: 0 0 50px rgba(251, 191, 36, 0.5), 0 0 100px rgba(251, 191, 36, 0.2);
  }
}
</style>

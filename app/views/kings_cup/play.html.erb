<% content_for :hide_footer, true %>
<%
  is_my_turn = current_kings_cup_player&.current_turn?
  current_player = @game.current_player
  last_card = @game.drawn_cards.first
%>

<div class="min-h-screen relative overflow-hidden"
     data-controller="kings-cup"
     data-kings-cup-game-id-value="<%= @game.id %>"
     data-kings-cup-player-id-value="<%= current_kings_cup_player&.id %>"
     data-kings-cup-is-host-value="<%= @game.host?(current_user) %>">

  <!-- Background -->
  <div class="absolute inset-0 pointer-events-none" style="clip-path: inset(0);">
    <div class="absolute top-0 left-0 -translate-x-1/2 w-64 h-64 md:w-[500px] md:h-[500px] bg-amber-500/15 rounded-full blur-3xl animate-pulse"></div>
    <div class="absolute top-1/3 right-0 translate-x-1/2 w-80 h-80 md:w-[500px] md:h-[500px] bg-pink-500/10 rounded-full blur-3xl animate-pulse" style="animation-delay: 1s;"></div>
    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2 w-96 h-96 md:w-[600px] md:h-[600px] bg-purple-500/10 rounded-full blur-3xl animate-pulse" style="animation-delay: 2s;"></div>
  </div>

  <!-- Top Bar -->
  <div class="relative z-20 px-4 py-3 bg-black/60 backdrop-blur-xl border-b border-white/5">
    <div class="flex items-center justify-between">
      <!-- Left: Cards Remaining -->
      <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg"
           style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.1) 100%);
                  border: 1px solid rgba(251, 191, 36, 0.2);">
        <span class="text-[10px] uppercase tracking-wider text-amber-400/70">Cartas</span>
        <span class="text-lg font-black text-white" data-kings-cup-target="cardsRemaining"
              style="text-shadow: 0 0 10px rgba(251, 191, 36, 0.4);">
          <%= @game.cards_remaining %>
        </span>
      </div>

      <!-- Center: Current Turn -->
      <div class="absolute left-1/2 -translate-x-1/2 text-center">
        <span class="text-[10px] text-white/50 uppercase tracking-wider block">Turno de</span>
        <span class="text-sm font-bold <%= is_my_turn ? 'text-cyan-400' : 'text-white' %>"
              data-kings-cup-target="currentPlayer"
              style="<%= is_my_turn ? 'text-shadow: 0 0 10px rgba(6, 182, 212, 0.5);' : '' %>">
          <%= is_my_turn ? 'Tu!' : current_player&.display_name %>
        </span>
      </div>

      <!-- Right: Kings Count + Menu -->
      <div class="flex items-center gap-2">
        <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg"
             style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.15) 0%, rgba(168, 85, 247, 0.1) 100%);
                    border: 1px solid rgba(236, 72, 153, 0.2);">
          <span class="text-lg">ğŸ‘‘</span>
          <span class="text-lg font-black text-white" data-kings-cup-target="kingsCount">
            <%= @game.kings_drawn %>/4
          </span>
        </div>

        <button type="button"
                class="p-2 rounded-lg text-white/50 hover:text-white hover:bg-white/10 transition-all"
                data-action="click->kings-cup#toggleMobileMenu">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="relative z-10 max-w-6xl mx-auto px-4 py-6">
    <div class="flex flex-col lg:flex-row lg:gap-8">

      <!-- Left: Cup Visualization -->
      <div class="lg:w-1/4 flex justify-center mb-6 lg:mb-0">
        <div class="relative" data-kings-cup-target="cup">
          <!-- Cup Container -->
          <div class="relative w-32 h-44 md:w-40 md:h-56">
            <!-- Cup Shape -->
            <div class="absolute inset-0 rounded-b-3xl rounded-t-lg overflow-hidden"
                 style="background: linear-gradient(180deg, rgba(30, 30, 30, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%);
                        border: 3px solid rgba(251, 191, 36, 0.4);
                        box-shadow: 0 0 30px rgba(251, 191, 36, 0.2), inset 0 0 20px rgba(0,0,0,0.5);">

              <!-- Liquid Fill -->
              <div class="absolute bottom-0 left-0 right-0 transition-all duration-1000 rounded-b-3xl bg-gradient-to-t from-amber-600 to-amber-500"
                   data-kings-cup-target="cupFill"
                   style="height: <%= @game.cup_fill_percentage %>%;
                          box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);"></div>

              <!-- Cup Shine -->
              <div class="absolute top-0 left-0 w-1/3 h-full"
                   style="background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, transparent 100%);"></div>
            </div>

            <!-- Crown on top -->
            <div class="absolute -top-8 left-1/2 -translate-x-1/2 text-4xl md:text-5xl"
                 style="filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.8));">
              ğŸ‘‘
            </div>
          </div>

          <!-- Cup Label -->
          <div class="text-center mt-4">
            <span class="text-amber-400 font-bold text-sm">Copa del Rey</span>
            <div class="text-white/50 text-xs"><%= @game.kings_drawn %>/4 Reyes</div>
          </div>
        </div>
      </div>

      <!-- Center: Deck + Card Display -->
      <div class="lg:w-1/2 flex-grow">

        <!-- Status Message -->
        <div class="text-center mb-6" data-kings-cup-target="gameStatus">
          <% if is_my_turn %>
            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full animate-pulse"
                 style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(34, 211, 238, 0.1) 100%);
                        border: 1px solid rgba(6, 182, 212, 0.4);">
              <span class="text-lg">ğŸ´</span>
              <span class="text-cyan-400 font-bold text-sm">Es tu turno! Saca una carta</span>
            </div>
          <% else %>
            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full"
                 style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
              <div class="w-2 h-2 rounded-full bg-amber-400 animate-pulse"></div>
              <span class="text-white/60 text-sm">Turno de <%= current_player&.display_name %>...</span>
            </div>
          <% end %>
        </div>

        <!-- Card Deck -->
        <div class="flex justify-center mb-6">
          <button type="button"
                  class="relative transition-all duration-300 <%= is_my_turn ? 'hover:scale-105 cursor-pointer' : 'opacity-60 cursor-not-allowed' %>"
                  data-action="click->kings-cup#drawCard"
                  <%= 'disabled' unless is_my_turn %>
                  data-kings-cup-target="deck">

            <!-- Stacked cards effect -->
            <% 3.times do |i| %>
              <div class="absolute w-[120px] h-[170px] md:w-[140px] md:h-[200px] rounded-xl"
                   style="top: <%= i * 2 %>px; left: <%= i * 2 %>px;
                          background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
                          border: 2px solid rgba(251, 191, 36, <%= 0.2 - i * 0.05 %>);
                          box-shadow: 0 4px 20px rgba(0,0,0,0.4);
                          z-index: <%= 3 - i %>;"></div>
            <% end %>

            <!-- Top card (main) -->
            <div class="relative w-[120px] h-[170px] md:w-[140px] md:h-[200px] rounded-xl flex items-center justify-center"
                 style="background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
                        border: 2px solid rgba(251, 191, 36, 0.4);
                        box-shadow: 0 0 30px rgba(251, 191, 36, 0.2), 0 10px 30px rgba(0,0,0,0.5);
                        z-index: 10;">
              <!-- Card back pattern -->
              <div class="w-[80%] h-[80%] rounded-lg flex items-center justify-center"
                   style="background: repeating-linear-gradient(45deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.1) 10px, transparent 10px, transparent 20px);
                          border: 2px solid rgba(251, 191, 36, 0.3);">
                <span class="text-4xl md:text-5xl">ğŸ‘‘</span>
              </div>
            </div>

            <% if is_my_turn %>
              <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 text-cyan-400 text-sm font-medium animate-bounce">
                Toca para sacar
              </div>
            <% end %>
          </button>
        </div>

        <!-- Last Drawn Card (if any) -->
        <% if last_card %>
          <div class="text-center">
            <p class="text-white/50 text-xs mb-3">Ultima carta:</p>
            <div class="inline-flex items-center gap-3 px-4 py-3 rounded-xl"
                 style="background: linear-gradient(145deg, rgba(26, 26, 26, 0.9) 0%, rgba(15, 15, 15, 0.9) 100%);
                        border: 1px solid <%= last_card.value == 'K' ? 'rgba(251, 191, 36, 0.4)' : 'rgba(236, 72, 153, 0.3)' %>;">
              <div class="w-12 h-16 rounded-lg flex flex-col items-center justify-center"
                   style="background: linear-gradient(145deg, #1a1a1a 0%, #0f0f0f 100%);
                          border: 1px solid <%= last_card.red? ? 'rgba(239, 68, 68, 0.3)' : 'rgba(255, 255, 255, 0.1)' %>;">
                <span class="font-bold <%= last_card.red? ? 'text-red-500' : 'text-white' %>"><%= last_card.value %></span>
                <span class="text-lg"><%= last_card.suit_symbol %></span>
              </div>
              <div class="text-left">
                <span class="text-lg"><%= last_card.rule_icon %></span>
                <span class="font-bold text-white ml-1"><%= last_card.rule_name %></span>
                <p class="text-white/60 text-xs mt-1">Por: <%= last_card.drawn_by&.display_name %></p>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Right: Players + Rules (Desktop) -->
      <div class="hidden lg:block lg:w-1/4">
        <!-- Players -->
        <div class="sticky top-20 p-4 rounded-2xl bg-white/5 border border-white/10 backdrop-blur-sm mb-4">
          <h3 class="font-bold text-white text-sm mb-3 flex items-center gap-2">
            <span class="text-amber-400">ğŸ‘¥</span> Jugadores
          </h3>
          <% @game.kings_cup_players.by_position.each do |player| %>
            <div class="flex items-center justify-between py-2 <%= player.current_turn? ? 'bg-cyan-500/10 rounded-lg px-2 -mx-2' : '' %>"
                 data-player-id="<%= player.id %>"
                 data-player-name="<%= player.display_name %>">
              <div class="flex items-center gap-2">
                <div class="w-7 h-7 rounded-full flex items-center justify-center text-[10px] font-bold text-white"
                     style="background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);">
                  <%= player.avatar_initials %>
                </div>
                <span class="text-xs text-white <%= player.current_turn? ? 'text-cyan-400 font-medium' : '' %>">
                  <%= player.display_name %>
                  <%= 'ğŸ´' if player.current_turn? %>
                  <%= 'â“' if player.is_question_master %>
                </span>
              </div>
              <% if player.mate %>
                <span class="text-xs text-pink-400" title="Compinche: <%= player.mate.display_name %>">ğŸ¤</span>
              <% end %>
            </div>
          <% end %>
        </div>

        <!-- Active Rules -->
        <% if @game.active_rules.any? %>
          <div class="p-4 rounded-2xl bg-white/5 border border-white/10 backdrop-blur-sm">
            <h3 class="font-bold text-white text-sm mb-3 flex items-center gap-2">
              <span class="text-purple-400">ğŸ“œ</span> Reglas Activas
            </h3>
            <div class="space-y-2" data-kings-cup-target="rulesList">
              <% @game.active_rules.limit(5).each do |rule| %>
                <div class="text-xs p-2 rounded-lg bg-purple-500/10 border border-purple-500/20">
                  <p class="text-white"><%= rule.rule_text %></p>
                  <p class="text-white/40 mt-1">Por: <%= rule.creator_name %></p>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Recent Cards (Mobile) -->
    <div class="mt-8 lg:hidden">
      <h3 class="text-sm font-bold text-white/70 mb-3">Historial</h3>
      <div class="flex gap-2 overflow-x-auto pb-2 -mx-4 px-4" data-kings-cup-target="recentCards">
        <% @game.drawn_cards.limit(5).each do |card| %>
          <div class="flex-shrink-0 flex items-center gap-2 px-3 py-2 rounded-lg bg-white/5 text-sm">
            <span class="<%= card.red? ? 'text-red-500' : 'text-white' %> font-bold"><%= card.value %><%= card.suit_symbol %></span>
            <span class="text-white/60">-</span>
            <span class="text-white/80"><%= card.drawn_by&.display_name %></span>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Drawn Card Overlay -->
  <div class="hidden fixed inset-0 z-50 items-center justify-center p-4"
       style="background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px);"
       data-kings-cup-target="drawnCard"
       data-action="click->kings-cup#dismissCard">
    <div class="w-full max-w-sm">
      <!-- Flip Card Container -->
      <div class="relative mx-auto perspective-1000" style="width: 200px; height: 280px;">
        <div class="relative w-full h-full transition-transform duration-700 transform-style-preserve-3d" data-flip-container>
          <!-- Card Back -->
          <div class="absolute inset-0 rounded-2xl backface-hidden"
               data-kings-cup-target="cardBack"
               style="background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
                      border: 3px solid rgba(251, 191, 36, 0.4);
                      box-shadow: 0 0 40px rgba(251, 191, 36, 0.3);">
            <div class="w-full h-full flex items-center justify-center">
              <div class="w-[80%] h-[80%] rounded-xl flex items-center justify-center"
                   style="background: repeating-linear-gradient(45deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.1) 10px, transparent 10px, transparent 20px);
                          border: 2px solid rgba(251, 191, 36, 0.3);">
                <span class="text-6xl">ğŸ‘‘</span>
              </div>
            </div>
          </div>

          <!-- Card Front -->
          <div class="absolute inset-0 rounded-2xl backface-hidden rotate-y-180"
               data-kings-cup-target="cardFront"
               style="background: linear-gradient(145deg, #1a1a1a 0%, #0f0f0f 100%);
                      border: 3px solid rgba(236, 72, 153, 0.4);
                      box-shadow: 0 0 40px rgba(236, 72, 153, 0.3);">
            <!-- Content will be set by JS -->
          </div>
        </div>
      </div>

      <!-- Rule Description -->
      <div class="mt-6 p-4 rounded-xl bg-white/10" data-kings-cup-target="drawnCardRule">
        <!-- Content will be set by JS -->
      </div>

      <p class="text-center text-white/50 text-sm mt-4">Toca para cerrar</p>
    </div>
  </div>

  <!-- Rule Modal -->
  <div id="rule-modal" class="hidden fixed inset-0 z-50 items-center justify-center p-4"
       style="background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px);">
    <div class="w-full max-w-md p-6 rounded-2xl"
         style="background: linear-gradient(145deg, rgba(26, 26, 26, 0.95) 0%, rgba(15, 15, 15, 0.95) 100%);
                border: 2px solid rgba(168, 85, 247, 0.4);">
      <div class="text-center mb-4">
        <span class="text-4xl">ğŸ“œ</span>
        <h2 class="text-xl font-bold text-white mt-2">Crea una Regla Nueva</h2>
        <p class="text-white/60 text-sm mt-1">Todos deben seguirla. Quien la rompa, bebe!</p>
      </div>

      <input type="text"
             data-kings-cup-target="ruleInput"
             placeholder="Ej: Nadie puede decir 'yo'"
             maxlength="200"
             class="w-full px-4 py-3 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-400/50 mb-4"
             style="background: rgba(20, 20, 20, 0.9); border: 1px solid rgba(255, 255, 255, 0.1);">

      <div class="flex gap-3">
        <button type="button"
                data-action="click->kings-cup#hideRuleModal"
                class="flex-1 py-3 rounded-xl font-medium text-white/70 bg-white/10 hover:bg-white/20 transition-all">
          Cancelar
        </button>
        <button type="button"
                data-action="click->kings-cup#submitRule"
                class="flex-1 py-3 rounded-xl font-bold text-white transition-all"
                style="background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);">
          Crear Regla
        </button>
      </div>
    </div>
  </div>

  <!-- Mate Selection Modal -->
  <div class="hidden fixed inset-0 z-50 items-center justify-center p-4"
       style="background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px);"
       data-kings-cup-target="mateModal">
    <div class="w-full max-w-md p-6 rounded-2xl"
         style="background: linear-gradient(145deg, rgba(26, 26, 26, 0.95) 0%, rgba(15, 15, 15, 0.95) 100%);
                border: 2px solid rgba(236, 72, 153, 0.4);">
      <div class="text-center mb-4">
        <span class="text-4xl">ğŸ¤</span>
        <h2 class="text-xl font-bold text-white mt-2">Elige tu Compinche</h2>
        <p class="text-white/60 text-sm mt-1">Cada vez que bebas, el tambien bebe!</p>
      </div>

      <div class="space-y-2" data-kings-cup-target="matePlayersList">
        <% @game.kings_cup_players.by_position.each do |player| %>
          <% next if player.id == current_kings_cup_player&.id %>
          <button type="button"
                  data-action="click->kings-cup#selectMate"
                  data-player-id="<%= player.id %>"
                  class="w-full flex items-center gap-3 p-3 rounded-xl bg-white/5 hover:bg-pink-500/20 border border-white/10 hover:border-pink-500/40 transition-all">
            <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-white"
                 style="background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);">
              <%= player.avatar_initials %>
            </div>
            <span class="font-medium text-white"><%= player.display_name %></span>
          </button>
        <% end %>
      </div>

      <button type="button"
              data-action="click->kings-cup#hideMateModal"
              class="w-full mt-4 py-3 rounded-xl font-medium text-white/70 bg-white/10 hover:bg-white/20 transition-all">
        Cancelar
      </button>
    </div>
  </div>

  <!-- Mobile Sidebar Overlay -->
  <div class="fixed inset-0 z-50 pointer-events-none" data-kings-cup-target="mobileOverlay">
    <div class="absolute inset-0 bg-black/70 opacity-0 transition-opacity duration-300 pointer-events-none"
         data-kings-cup-target="mobileBackdrop"
         data-action="click->kings-cup#toggleMobileMenu"></div>
    <div class="absolute top-0 right-0 h-full w-4/5 max-w-sm bg-black/95 backdrop-blur-md transform translate-x-full transition-transform duration-300 border-l border-white/10"
         data-kings-cup-target="mobilePanel">
      <div class="p-4 border-b border-white/10 flex items-center justify-between">
        <h3 class="font-bold text-white">Menu</h3>
        <button type="button" class="p-2 text-white/50 hover:text-white" data-action="click->kings-cup#toggleMobileMenu">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="p-4 space-y-4 overflow-y-auto max-h-[calc(100vh-80px)]">
        <!-- Players -->
        <div>
          <h4 class="text-sm font-bold text-white/70 mb-2">Jugadores</h4>
          <% @game.kings_cup_players.by_position.each do |player| %>
            <div class="flex items-center justify-between py-2">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white"
                     style="background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);">
                  <%= player.avatar_initials %>
                </div>
                <span class="text-sm text-white">
                  <%= player.display_name %>
                  <%= 'ğŸ´' if player.current_turn? %>
                  <%= 'â“' if player.is_question_master %>
                </span>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Active Rules -->
        <% if @game.active_rules.any? %>
          <div>
            <h4 class="text-sm font-bold text-white/70 mb-2">Reglas Activas</h4>
            <% @game.active_rules.each do |rule| %>
              <div class="text-sm p-2 rounded-lg bg-purple-500/10 border border-purple-500/20 mb-2">
                <p class="text-white"><%= rule.rule_text %></p>
                <p class="text-white/40 text-xs mt-1">Por: <%= rule.creator_name %></p>
              </div>
            <% end %>
          </div>
        <% end %>

        <!-- Leave Button -->
        <div class="pt-4 border-t border-white/10">
          <%= button_to "Abandonar Partida",
              kings_cup_leave_path(@game),
              method: :post,
              class: "w-full py-3 rounded-xl text-sm font-bold text-red-400 bg-red-500/10 border border-red-500/30",
              data: { turbo_confirm: "Abandonar la partida?" } %>
        </div>
      </div>
    </div>
  </div>

</div>

<style>
  .perspective-1000 { perspective: 1000px; }
  .transform-style-preserve-3d { transform-style: preserve-3d; }
  .backface-hidden { backface-visibility: hidden; }
  .rotate-y-180 { transform: rotateY(180deg); }
  .flipped { transform: rotateY(180deg); }
</style>
